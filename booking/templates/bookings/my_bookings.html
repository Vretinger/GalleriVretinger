{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home.css' %}">
{% endblock %}

{% block content %}
<div class="container py-5" style="min-height: 90vh;">
  <h2>{% trans "My Bookings / Hosted Events" %}</h2>

  <!-- --- Active / Upcoming Events --- -->
  <h3 class="mt-4">{% trans "Upcoming / Ongoing Events" %}</h3>
  {% if active_events %}
    {% for e in active_events %}
      <div class="container booking-event my-4">
        <div class="row mb-5 p-3 border rounded shadow-sm">
          <div class="col-md-4">
            <p class="booking-info">
              <strong>{% trans "Start:" %}</strong> {{ e.booking.start_date }}<br>
              <strong>{% trans "End:" %}</strong> {{ e.booking.end_date }}<br>
              <strong>{% trans "Total Price:" %}</strong> {{ e.booking.total_price }} SEK<br>

              {% if e.booking.initial_payment_done and not e.booking.final_payment_done %}
                <div class="mt-3">
                  <p class="text-warning">
                    {% trans "Your remaining balance of" %} {{ e.booking.remaining_balance|floatformat:0 }} SEK
                    {% trans "is due by" %} {{ e.booking.final_payment_due_date }}.
                  </p>
                  <a href="{% url 'pay_remaining_balance' e.booking.id %}" class="btn btn-warning">
                    {% trans "Pay Remaining Balance" %}
                  </a>
                </div>
              {% elif e.booking.final_payment_done %}
                <p class="text-success mt-3">{% trans "Booking fully paid" %}</p>
              {% endif %}

              {% if e.event.is_drop_in %}
                <p class="text-success mt-3"><strong>Drop-in Event</strong></p>
              {% elif e.event.bookings.exists %}
                <h4 class="mt-4">{% trans "Attendees" %}</h4>
                <ul class="list-group list-group-flush mb-3">
                  {% for attendee in e.event.bookings.all %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                      {{ attendee.name }} ({{ attendee.email }})
                      {% if attendee.num_guests > 1 %}
                        <span class="badge bg-primary rounded-pill">{{ attendee.num_guests }}</span>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              {% endif %}
            </p>
          </div>

          <div class="col-md-8">
            <div class="event-item event-section row align-items-center py-4 event-button-wrapper">
              {% if forloop.counter|divisibleby:2 %}
                {% include "events/_my_event_right.html" %}
              {% else %}
                {% include "events/_my_event_left.html" %}
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <p class="text-muted">{% trans "No upcoming or ongoing events." %}</p>
  {% endif %}

  <!-- --- Ended Events --- -->
  <h3 class="mt-5">{% trans "Ended Events" %}</h3>
  {% if ended_events %}
    {% for e in ended_events %}
      <div class="container booking-event my-4">
        <div class="row mb-5 p-3 border rounded shadow-sm ended-event" style="opacity:0.7;">
          <div class="col-md-4">
            <p class="booking-info">
              <strong>{% trans "Start:" %}</strong> {{ e.booking.start_date }}<br>
              <strong>{% trans "End:" %}</strong> {{ e.booking.end_date }}<br>
              <strong>{% trans "Total Price:" %}</strong> {{ e.booking.total_price }} SEK<br>

              {% if e.event.is_drop_in %}
                <p class="text-success mt-3"><strong>Drop-in Event</strong></p>
              {% elif e.event.bookings.exists %}
                <h4 class="mt-4">{% trans "Attendees" %}</h4>
                <ul class="list-group list-group-flush mb-3">
                  {% for attendee in e.event.bookings.all %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                      {{ attendee.name }} ({{ attendee.email }})
                      {% if attendee.num_guests > 1 %}
                        <span class="badge bg-primary rounded-pill">{{ attendee.num_guests }}</span>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              {% endif %}
            </p>
          </div>

          <div class="col-md-8">
            <div class="event-item event-section row align-items-center py-4 event-button-wrapper">
              {% if forloop.counter|divisibleby:2 %}
                {% include "events/_my_event_right.html" %}
              {% else %}
                {% include "events/_my_event_left.html" %}
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <p class="text-muted">{% trans "No ended events." %}</p>
  {% endif %}

</div>

{% if request.GET.show_modal %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const modalElement = document.getElementById("dynamicModal");
  const modalInstance = new bootstrap.Modal(modalElement);
  modalElement.querySelector("#dynamicModalTitle").textContent = "{% trans 'Thank You!' %}";
  modalElement.querySelector("#dynamicModalMessage").textContent = "{% trans 'Your booking has been received. A confirmation will be sent to your email. Check your spam folder as well.' %}";
  modalInstance.show();
});
</script>
{% endif %}
{% endblock %}
